<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>SJSU Campus Copilot</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 32px; max-width: 900px; }
    .card { border: 1px solid #ddd; border-radius: 12px; padding: 16px; margin: 16px 0; }
    .row { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
    button { padding: 8px 14px; border-radius: 8px; border: 1px solid #ccc; cursor: pointer; }
    input[type="text"], textarea { padding: 8px; width: 100%; max-width: 560px; }
    textarea { min-height: 100px; }
    .small { color:#666; font-size:13px }
    .pill { display:inline-block; padding:2px 8px; border-radius:999px; background:#eef; font-size:12px; margin-right:8px; }
    #answer { white-space: pre-wrap; }
  </style>
</head>
<body>
  <h1>SJSU Campus Copilot</h1>
  <div class="small">Flask + Hugging Face + Chroma â€¢ Prometheus at <code>/metrics</code></div>

  <div class="card">
    <h2>1) Upload & Ingest Files</h2>
    <input id="fileInput" type="file" multiple />
    <button id="uploadBtn">Ingest selected files</button>
    <div id="uploadStatus" class="small"></div>
    <div class="small">PDF, DOCX, TXT/MD/LOG, CSV</div>
  </div>

  <div class="card">
    <h2>2) Index Local Folder</h2>
    <div class="row">
      <input id="dirInput" type="text" value="{{ default_dir }}" />
      <button id="dirBtn">Ingest folder</button>
    </div>
    <div id="dirStatus" class="small"></div>
  </div>

  <div class="card">
    <h2>3) Ask a Question</h2>
    <textarea id="question" placeholder="e.g., What is the late submission policy?"></textarea>
    <div class="row">
      <button id="askBtn">Ask</button>
      <span id="askStatus" class="small"></span>
    </div>
    <h3>Answer</h3>
    <div id="answer"></div>
    <div id="citations"></div>
  </div>

  <script>
    const $ = (id) => document.getElementById(id);

    $("uploadBtn").onclick = async () => {
      const files = $("fileInput").files;
      if (!files || files.length === 0) { $("uploadStatus").textContent = "Select files first."; return; }
      const fd = new FormData();
      for (const f of files) fd.append("files", f);
      $("uploadStatus").textContent = "Uploading and indexing...";
      try {
        const res = await fetch("/ingest-batch", { method: "POST", body: fd });
        $("uploadStatus").textContent = JSON.stringify(await res.json());
      } catch (e) { $("uploadStatus").textContent = "Error: " + e; }
    };

    $("dirBtn").onclick = async () => {
      const dir = $("dirInput").value.trim();
      if (!dir) { $("dirStatus").textContent = "Enter a folder path."; return; }
      $("dirStatus").textContent = "Indexing...";
      try {
        const res = await fetch("/ingest-dir", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ dir })
        });
        $("dirStatus").textContent = JSON.stringify(await res.json());
      } catch (e) { $("dirStatus").textContent = "Error: " + e; }
    };

    $("askBtn").onclick = async () => {
      const q = $("question").value.trim();
      if (!q) { $("askStatus").textContent = "Enter a question."; return; }
      $("askStatus").textContent = "Thinking...";
      $("answer").textContent = ""; $("citations").textContent = "";
      try {
        const res = await fetch("/ask", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ query: q })
        });
        const json = await res.json();
        if (json.error) { $("askStatus").textContent = "Error: " + json.error; return; }
        $("askStatus").textContent = "Done.";
        $("answer").textContent = json.answer || "";
        const cites = (json.citations || [])
          .map(c => `<span class="pill">${(c.source || "doc")} p.${c.page ?? "?"}</span>`).join(" ");
        $("citations").innerHTML = cites;
      } catch (e) { $("askStatus").textContent = "Error: " + e; }
    };
  </script>
</body>
</html>
